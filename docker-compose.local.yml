version: "3.8"

services:
  fingerprint-converter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fingerprint-converter-local
    restart: unless-stopped
    ports:
      - "9090:9090"
    environment:
      # Server Configuration
      PORT: 9090
      BASE_URL: http://localhost:9090
      APP_ENV: development
      READ_TIMEOUT: 5m
      WRITE_TIMEOUT: 5m
      BODY_LIMIT: 524288000  # 500MB
      
      # Performance Tuning
      GOMEMLIMIT: 2GiB
      GOGC: 100
      MAX_WORKERS: 64
      BUFFER_POOL_SIZE: 100
      BUFFER_SIZE: 10485760  # 10MB
      REQUEST_TIMEOUT: 5m
      DOWNLOAD_TIMEOUT: 2m  # Aumentado para v√≠deos grandes
      MAX_DOWNLOAD_SIZE: 524288000  # 500MB
      
      # Cache Configuration
      CACHE_DIR: /tmp/media-cache
      CACHE_TTL: 28m
      FILE_TTL: 30m
      ENABLE_CACHE: "true"
      
      # Anti-Fingerprint Settings
      DEFAULT_AF_LEVEL: moderate
      
      # Logging
      LOG_LEVEL: info
      ENABLE_PERFORMANCE_LOGS: "true"
      DEBUG: "false"
      
      # Production Settings
      PRODUCTION_MODE: "false"
      ENABLE_CORS: "true"
      
      # Monitoring
      ENABLE_HEALTH_CHECK: "true"
      ENABLE_STATS_ENDPOINT: "true"

    # Use tmpfs for high-performance temporary file storage
    tmpfs:
      - /tmp/media-cache:size=2G,mode=1777

    # Resource limits (ajustado para desenvolvimento)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
